- hosts: master

  tasks:

    - name: Get join token

      become: yes

      become_user: vagrant

      shell: sudo kubeadm token create  --print-join-command

      register: kubernetes_join_command



    - name: Copy join command to local file.

      become: yes

      local_action: copy content="{{ kubernetes_join_command.stdout_lines[0] }}" dest="/tmp/kubernetes_join_command" mode=0777



    - name: Append cri-socket to join command file

      become: yes

      shell: echo "--cri-socket=unix:///var/run/cri-dockerd.sock" >> /tmp/kubernetes_join_command



- hosts: workers

  become: yes

  gather_facts: yes

  tasks:

   - name: Copy join command from Ansiblehost to the worker nodes.

     become: yes

     copy:

       src: /tmp/kubernetes_join_command

       dest: /tmp/kubernetes_join_command

       mode: 0777



   - name: Join the Worker nodes to the cluster.

     become: yes

     command: sh /tmp/kubernetes_join_command

     register: joined_or_not
